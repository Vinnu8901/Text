<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Offline XPath Locator &amp; POM + API Studio</title>
<style>
  :root{
    --bg:#0f1217; --panel:#151a21; --panel2:#171e27; --chip:#202734;
    --txt:#e9eef5; --dim:#9db0c5; --brd:#273243;
    --accent:#7c5cff; --ok:#19c37d; --warn:#ffbf47; --bad:#ff4d4f;
    --ed-bg:#fbfcfe; --ed-brd:#dfe6ee; --ed-txt:#0f172a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  .app{display:grid;grid-template-columns:280px 1fr;height:100%}
  /* Sidebar */
  .side{background:linear-gradient(180deg,#0f1217 0,#0f1217 60%,#0b0e13 100%);border-right:1px solid var(--brd);padding:18px 16px;overflow:auto}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;margin-bottom:14px}
  .beacon{width:10px;height:10px;border-radius:50%;background:linear-gradient(180deg,var(--accent),#563bff);box-shadow:0 0 10px var(--accent)}
  .section{margin:16px 0 8px;color:var(--dim);font-size:12px;letter-spacing:.12em;text-transform:uppercase}
  .btn{width:100%;text-align:left;cursor:pointer;background:var(--panel);border:1px solid var(--brd);border-radius:10px;padding:10px 12px;color:var(--txt);font-weight:600;margin-bottom:8px;transition:.15s}
  .btn:hover{background:var(--panel2);transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(180deg,var(--accent),#6047ff);border-color:#5b49f2}
  .btn.danger{background:linear-gradient(180deg,#ff4d4f,#e13b3e);border-color:#e13b3e}
  .pill{display:flex;gap:8px;align-items:center;background:var(--chip);border:1px solid var(--brd);border-radius:999px;padding:8px 10px;width:max-content;color:var(--dim);font-size:12px}
  .switch{display:flex;gap:8px}
  .switch .sw{padding:8px 12px;border:1px solid var(--brd);border-radius:10px;background:var(--panel);cursor:pointer}
  .sw.active{outline:2px solid rgba(124,92,255,.35)}
  /* Main */
  .main{display:grid;grid-template-rows:auto 1fr auto}
  .toolbar{display:flex;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--brd);background:var(--panel);position:sticky;top:0;z-index:5}
  .toolbar .title{font-weight:800}
  .hint{color:var(--dim);font-size:12px;margin-left:auto}
  .mode-chips{display:flex;gap:8px}
  .mode-chip{padding:6px 10px;border-radius:8px;background:#0f1419;border:1px solid var(--brd);cursor:pointer;color:var(--dim);font-weight:700}
  .mode-chip.active{background:linear-gradient(90deg,var(--accent),#5a48f0);color:#fff;box-shadow:0 6px 18px rgba(90,72,240,.12)}
  .workspace{display:grid;grid-template-columns:48% 52%;gap:14px;padding:14px;overflow:auto}
  .card{background:var(--panel);border:1px solid var(--brd);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .card .head{background:var(--panel2);padding:12px 14px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:10px;font-weight:700}
  .card .body{padding:12px;display:flex;flex-direction:column;gap:10px;min-height:140px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,input[type="text"]{background:var(--panel2);border:1px solid var(--brd);border-radius:10px;color:var(--txt);padding:8px 10px}
  textarea.ed{background:var(--ed-bg);border:1px solid var(--ed-brd);border-radius:12px;color:var(--ed-txt);padding:10px;min-height:130px;font-family:ui-monospace,Menlo,Consolas,monospace}
  iframe#preview{width:100%;height:360px;background:#fff;border:none;border-radius:8px}
  .drop{display:flex;justify-content:center;align-items:center;height:56px;border:2px dashed #3a475a;border-radius:12px;color:var(--dim)}
  .chip-tabs{display:flex;gap:8px;flex-wrap:wrap;background:var(--panel);border-bottom:1px solid var(--brd);padding:8px 12px}
  .chip{padding:8px 12px;border:1px solid var(--brd);border-radius:999px;background:#1a2230;color:#b8c6d9;font-size:12px;cursor:pointer}
  .chip.active{color:#fff;border-color:var(--accent);box-shadow:0 0 0 2px rgba(124,92,255,.25) inset}
  .list{display:flex;flex-direction:column;gap:6px;max-height:280px;overflow:auto;background:var(--ed-bg);border:1px solid var(--ed-brd);border-radius:12px;padding:8px}
  .loc-row{background:#fff;border:1px solid #e6ecf5;border-radius:8px;padding:8px 10px;color:#0f172a;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:8px}
  .loc-row:hover{background:#f5f8ff}
  .badge{font-size:11px;background:#eef2ff;border:1px solid #d8e1ff;border-radius:999px;padding:2px 8px;margin-right:8px;color:#1f2b46}
  .footer{display:flex;gap:10px;align-items:center;padding:12px 16px;border-top:1px solid var(--brd);background:var(--panel)}
  .toast{position:fixed;bottom:16px;right:16px;background:#131a24;border:1px solid #2a3648;color:#cfe3ff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.15s}
  .toast.show{opacity:1;transform:translateY(0)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .small{font-size:12px;color:var(--dim)}
  .hidden{display:none}
  @media (max-width:980px){.workspace{grid-template-columns:1fr}} 
  

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
<div class="app">
<!-- Sidebar -->
<aside class="side">
<div class="brand"><span class="beacon"></span> Offline XPath Studio</div>
<div class="section">Workspace</div>
<button class="btn" id="btnPaste">Paste HTML</button>
<button class="btn" id="btnOpenFile">Open .html file</button>
<button class="btn" id="btnExport">Export (locators + checks)</button>
<div class="section">POM &amp; Steps</div>
<div class="switch">
<div class="sw active" data-fw="selenium">Selenium</div>
<div class="sw" data-fw="playwright">Playwright</div>
</div>
<div style="height:8px"></div>
<div class="switch">
<div class="sw active" data-runner="testng">Maven + TestNG</div>
<div class="sw" data-runner="cucumber">Maven + Cucumber</div>
</div>
<div style="height:8px"></div>
<div class="switch">
<div class="sw active" data-lang="java">Java</div>
<div class="sw" data-lang="javascript">JavaScript</div>
<div class="sw" data-lang="python">Python</div>
<div class="sw" data-lang="typescript">TypeScript</div>
</div>
<button class="btn primary" id="btnGenPOM" style="margin-top:10px">Generate POM + Steps</button>
<button class="btn" id="btnDownloadPOM">Download POM file</button>
<button class="btn" id="btnDownloadSteps">Download Steps file</button>
<button class="btn" id="btnZipAll">Download ZIP (All)</button>
</aside>
<!-- Main -->
<main class="main">
<div class="toolbar">
<div class="title">1) Paste/Open HTML → 2) Pick a locator panel → 3) Copy rows → 4) Generate POM + Steps</div>
<div class="mode-chips">
<div class="mode-chip active" id="modePOM">POM Studio</div>
<div class="mode-chip" id="modeAPI">API Studio</div>
</div>
<div class="hint">Row click = copy • Priority: name → label → placeholder</div>
</div>
<div class="workspace">
<!-- Left panel for POM Studio -->
<section class="card" id="pomLeftCard">
<div class="head">Paste HTML</div>
<div class="body">
<textarea class="ed" id="pasteBox" placeholder="Paste full page HTML here..."></textarea>
<div class="row">
<button class="btn primary" id="btnRender" style="width:auto">Render Preview</button>
<button class="btn danger" id="btnClear" style="width:auto">Clear</button>
</div>
<div class="head" style="margin:6px -12px 0;border-radius:10px">Preview</div>
<div class="drop" id="dropZone">Drop .html here</div>
<iframe id="preview" sandbox="allow-same-origin allow-forms allow-scripts"></iframe>
</div>
</section>
<!-- Left panel for API Studio -->
<section class="card hidden" id="apiLeftCard">
<div class="head">Paste cURL</div>
<div class="body">
<textarea class="ed mono" id="curlBox" placeholder="Paste cURL here (from Postman/Insomnia)..."></textarea>
<div class="row" style="align-items:center; gap:12px">
<label class="small">Framework</label>
<select id="apiFramework">
<option value="restassured">RestAssured (Java)</option>
<option value="karate">Karate DSL</option>
</select>
<button class="btn primary" id="btnGenAPI" style="width:auto">Generate API Code</button>
</div>
</div>
</section>
<!-- Right -->
<section class="card" id="rightCard">
<div class="head">Locators &amp; Code</div>
<div class="body" id="rightBody">
<div id="pomPanel">
<div class="chip-tabs">
<div class="chip active" data-paneltab="basic">Basic</div>
<div class="chip" data-paneltab="wildcards">Wildcards</div>
<div class="chip" data-paneltab="axes">Axes</div>
<div class="chip" data-paneltab="functions">Functions</div>
<div class="chip" data-paneltab="sf">Salesforce</div>
<!-- NEW: Pega tab -->
<div class="chip" data-paneltab="pega">Pega</div>
</div>
<div class="list" id="locList"></div>
<div class="head" style="margin:8px -12px 0;border-radius:10px">Output</div>
<textarea class="ed mono" id="output" placeholder="POM / Steps / Export text will appear here…"></textarea>
</div>
<div class="hidden" id="apiPanel">
<div class="row" style="align-items:flex-end">
<div style="flex:1">
<label class="small">Method</label>
<select id="apiMethod"><option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option></select>
</div>
<div style="flex:3">
<label class="small">Endpoint</label>
<input id="apiUrl" placeholder="https://api.example.com/..." type="text"/>
</div>
</div>
<div style="display:flex;gap:10px">
<div style="flex:1">
<label class="small">Headers (JSON)</label>
<textarea class="ed" id="apiHeaders" style="min-height:80px">{ "Content-Type":"application/json" }</textarea>
</div>
<div style="flex:1">
<label class="small">Body (JSON)</label>
<textarea class="ed" id="apiBody" style="min-height:80px">{}</textarea>
</div>
</div>
<div class="row">
<button class="btn primary" id="btnGenerateApi">Generate Code</button>
<button class="btn" id="btnPasteCurl">Paste cURL → Parse</button>
<button class="btn" id="btnCopyApiCode">Copy Code</button>
</div>
<div class="head" style="margin:8px -12px 0;border-radius:10px">Generated API Code</div>
<textarea class="ed mono" id="apiCode" placeholder="RestAssured / Playwright API code will appear here..."></textarea>
<div class="head" style="margin:8px -12px 0;border-radius:10px">Response / Paste here</div>
<textarea class="ed mono" id="apiResponse" placeholder="Paste response JSON here to visualize or to include in tests..."></textarea>
</div>
</div>
</section>
</div>
<div class="footer">
<div class="pill">Copy any locator by clicking its row</div>
<div class="pill">Export includes isVisible / isClickable / isEnabled / isDisabled with waits</div>
</div>
</main>
</div><input accept=".html,.htm,.xhtml,.txt" hidden="" id="hiddenFile" type="file"/>
<div class="toast" id="toast">Copied ✔</div>
<script>
/* =========================
   Helpers & State
========================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const preview = $('#preview');
const locList = $('#locList');
const output = $('#output');
const pasteBox = $('#pasteBox');
const toast = $('#toast');
const hiddenFile = $('#hiddenFile');

let CURRENT_HTML = '';
let CURRENT_DOC = null; // DOM parsed from paste/open
let CURRENT_LOCATORS = []; // [{type,text,xpaths:{basic,wildcards,axes,functions,sf,pega}, playwright, css, id}]
let POM_CACHE = { pom:'', steps:'' };

/* =========================
   UI: Mode switching
========================= */
const modePOM = $('#modePOM');
const modeAPI = $('#modeAPI');
const pomPanel = $('#pomPanel');
const apiPanel = $('#apiPanel');
const leftHead = $('#leftHead');

modePOM.addEventListener('click',()=>setMode('pom'));
modeAPI.addEventListener('click',()=>setMode('api'));
function setMode(m){
  modePOM.classList.remove('active'); 
  modeAPI.classList.remove('active');

  if(m==='pom'){ 
    modePOM.classList.add('active'); 

    // Right side
    pomPanel.classList.remove('hidden'); 
    apiPanel.classList.add('hidden'); 

    // Left side
    $('#pomLeftCard').classList.remove('hidden');
    $('#apiLeftCard').classList.add('hidden');
  }
  else { 
    modeAPI.classList.add('active'); 

    // Right side
    pomPanel.classList.add('hidden'); 
    apiPanel.classList.remove('hidden'); 

    // Left side
    $('#pomLeftCard').classList.add('hidden');
    $('#apiLeftCard').classList.remove('hidden');
  }
}
  

/* =========================
   UI: Sidebar switches
========================= */
$$('.sw').forEach(sw=>{
  sw.addEventListener('click',()=>{
    const groupAttr = [...sw.attributes].find(a=>/^data-/.test(a.name)).name;
    $$(`.sw[${groupAttr}]`).forEach(x=>x.classList.remove('active'));
    sw.classList.add('active');
  });
});

/* =========================
   File open / paste / clear
========================= */
$('#btnOpenFile').addEventListener('click', ()=> hiddenFile.click());
hiddenFile.addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload = ev => { pasteBox.value = ev.target.result; renderPreview(); };
  reader.readAsText(f);
});

$('#btnPaste').addEventListener('click', async ()=>{
  try{
    const txt = await navigator.clipboard.readText();
    if(!txt) return showToast('Clipboard empty');
    pasteBox.value = txt;
    renderPreview();
  }catch(e){ showToast('Clipboard permission denied'); }
});

$('#btnClear').addEventListener('click', ()=>{
  pasteBox.value = '';
  preview.srcdoc = '<body style="font-family:sans-serif"><h3>Preview cleared</h3></body>';
  CURRENT_HTML = ''; CURRENT_DOC = null; CURRENT_LOCATORS = []; locList.innerHTML = ''; output.value = '';
});

/* =========================
   Drag & Drop to preview area
========================= */
const dropZone = $('#dropZone');
['dragenter','dragover'].forEach(ev=>dropZone.addEventListener(ev,e=>{ e.preventDefault(); dropZone.style.borderColor='#5a48f0'; }));
['dragleave','drop'].forEach(ev=>dropZone.addEventListener(ev,e=>{ e.preventDefault(); dropZone.style.borderColor='#3a475a'; }));
dropZone.addEventListener('drop', e=>{
  const f=e.dataTransfer.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload = ev => { pasteBox.value = ev.target.result; renderPreview(); };
  reader.readAsText(f);
});

/* =========================
   Render preview
========================= */
$('#btnRender').addEventListener('click', renderPreview);

/* =========================
   Locator Panels: tab + sidebar sync
========================= */
$('.chip-tabs').addEventListener('click', e=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  $$('.chip').forEach(c=>c.classList.remove('active')); chip.classList.add('active');
  fillLocatorList(chip.dataset.paneltab || 'basic');
});
$$('.side .btn[data-panel]').forEach(b=>b.addEventListener('click',()=>{
  $$('.chip').forEach(c=>c.classList.remove('active'));
  const sel = b.dataset.panel;
  const chip = $(`.chip[data-paneltab="${sel}"]`);
  if(chip){ chip.classList.add('active'); fillLocatorList(sel); }
  showToast(sel+' panel');
}));

</script>
  
  
<script>

<script>
/**
 * Adhyan Full Patch — Single-file replacement (reordered & inline-safe)
 * Paste this <script>...</script> in place of your previous script block.
 * API exported on window.AdhyPatch: extractAllLocators(), fillLocatorList(panel),
 * openDynamicPicker(), tryHighlightByXPath(xpath), buildArtifactsFiles(options), downloadZipFromFiles(files, name)
 */
(function AdhyanFullPatch(){
  const NS = window.AdhyPatch = window.AdhyPatch || {};
  NS.DEBUG = false;
  function dbg(...args){ if(NS.DEBUG) console.debug('[AdhyPatch]', ...args); }

  /* ===================== 2) SAFE UTILITIES ===================== */
  function xpathLiteral(s){
    s = String(s || '');
    if (s.indexOf('"') === -1) return `"${s}"`;
    if (s.indexOf("'") === -1) return `'${s}'`;
    const parts = s.split('"'), out = [];
    for (let i=0;i<parts.length;i++){
      if (parts[i] !== '') out.push(`"${parts[i].replace(/\\/g,'\\\\')}"`);
      if (i < parts.length - 1) out.push(`'"'`);
    }
    return `concat(${out.join(',')})`;
  }
  function safeAttr(el, name){
    try { return el && el.getAttribute ? el.getAttribute(name) : null; } catch(e){ return null; }
  }

  /* ===================== 3) FALLBACK HELPERS ===================== */
  if (typeof window.generateCssSelector !== 'function'){
    window.generateCssSelector = function(el){
      if(!el || !el.tagName) return '';
      const tag = el.tagName.toLowerCase();
      if (el.id) return `#${el.id}`;
      const cls = (el.className||'').toString().split(/\s+/).filter(Boolean)[0];
      if (cls) return `${tag}.${cls}`;
      const name = safeAttr(el,'name');
      if (name) return `${tag}[name="${name}"]`;
      return tag;
    };
  }
  if (typeof window.generatePlaywrightSelectors !== 'function'){
    window.generatePlaywrightSelectors = function(el){
      const cs = window.generateCssSelector(el) || '';
      return { css: cs, text: (el && (el.innerText||el.textContent) || '').trim() };
    };
  }
  if (typeof window.bestLabelFor !== 'function'){
    window.bestLabelFor = function(el){
      if(!el) return null;
      const id = el.id;
      if (id){
        try { const lab = document.querySelector(`label[for="${id}"]`); if(lab && lab.textContent) return lab.textContent.trim(); } catch(e){}
      }
      const p = el.closest ? el.closest('label') : null;
      if (p && p.textContent) return p.textContent.trim();
      return null;
    };
  }

  /* ===================== 4) UI HELPERS ===================== */
  function showToast(msg, ms){
    ms = ms || 1800;
    try {
      if (typeof window.showToast === 'function'){ window.showToast(msg); return; }
      let t = document.getElementById('__adhy_toast');
      if (t){ t.textContent = msg; t.style.opacity = '1'; clearTimeout(t._t); t._t = setTimeout(()=>{ t.style.opacity='0'; }, ms); return; }
      t = document.createElement('div');
      t.id = '__adhy_toast';
      t.style.cssText = 'position:fixed;right:16px;bottom:16px;padding:8px 12px;border-radius:8px;background:rgba(0,0,0,0.78);color:#fff;z-index:2147483650;transition:opacity .18s;opacity:1;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;';
      t.textContent = msg;
      document.body.appendChild(t);
      t._t = setTimeout(()=>{ try{ t.style.opacity='0'; } catch(e){} }, ms);
    } catch(e){ console.log(msg); }
  }

  async function copyToClipboard(text){
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        showToast('Copied to clipboard');
        return true;
      }
    } catch(e){ dbg('clipboard write failed', e); }
    try {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed'; ta.style.left = '-9999px'; ta.style.top = '0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      const ok = document.execCommand && document.execCommand('copy');
      document.body.removeChild(ta);
      showToast(ok ? 'Copied to clipboard' : 'Copy fallback used');
      return !!ok;
    } catch(e){
      try { await navigator.clipboard.writeText(text); showToast('Copied to clipboard'); return true; } catch(e2){}
      alert('Unable to copy — please copy manually:\n\n' + text);
      return false;
    }
  }
  NS.copyToClipboard = copyToClipboard;

  /* ===================== 5) SKIP / DEDUPE / LABELS ===================== */
  function isHiddenByInlineStyle(el){
    const s = (safeAttr(el,'style')||'').toLowerCase();
    return /display\s*:\s*none|visibility\s*:\s*hidden|opacity\s*:\s*0|pointer-events\s*:\s*none/.test(s);
  }
  function hasUsefulLabel(el){
    if(!el) return false;
    if (safeAttr(el,'aria-label')) return true;
    if (safeAttr(el,'placeholder')) return true;
    if (safeAttr(el,'name')) return true;
    const id = el.id;
    if (id){
      try{ if(document.querySelector(`label[for="${id}"]`)) return true; } catch(e){}
    }
    const t = (el.textContent||'').trim();
    return t.length > 0;
  }
  function isSFNoise(el){
    const cls = el.className || '';
    if(/\bslds-assistive-text\b/.test(cls)) return true;
    if(/\bslds-hide\b/.test(cls)) return true;
    if (safeAttr(el,'role') === 'presentation') return true;
    return false;
  }
  function isPegaNoise(el){
    const ctl = safeAttr(el,'data-ctl') || '';
    if (ctl === 'Tooltip') return true;
    if (ctl === 'Icon' && !el.hasAttribute('role') && !el.onclick) return true;
    return false;
  }
  function shouldSkip(el){
    if(!el || el.nodeType !== 1) return true;
    const tag = el.tagName.toLowerCase();
    if (el.hasAttribute('hidden')) return true;
    if (safeAttr(el,'aria-hidden') === 'true') return true;
    if (isHiddenByInlineStyle(el)) return true;
    if (el.hasAttribute('disabled') || safeAttr(el,'aria-disabled') === 'true') return true;
    if (el.hasAttribute('readonly')) return true;
    if (tag === 'input' && (safeAttr(el,'type')||'').toLowerCase() === 'hidden') return true;
    if (tag === 'a' && (!el.hasAttribute('href') || safeAttr(el,'href') === '#')) return true;
    if (isSFNoise(el)) return true;
    if (isPegaNoise(el)) return true;
    if (!hasUsefulLabel(el)) return true;
    return false;
  }
  function getLabelFor(el){
    try { if (typeof window.bestLabelFor === 'function') return window.bestLabelFor(el); } catch(e){}
    const id = el && el.getAttribute ? el.getAttribute('id') : null;
    if (id) {
      try { const lab = document.querySelector(`label[for="${id}"]`); if (lab && lab.textContent) return lab.textContent.trim(); } catch(e){}
    }
    const parentLabel = el && el.closest ? el.closest('label') : null;
    if (parentLabel && parentLabel.textContent) return parentLabel.textContent.trim();
    return null;
  }
  function getSmartAnchorTextSafe(el){
    try { if (typeof window.getSmartAnchorText === 'function') return window.getSmartAnchorText(el) || ''; } catch(e){}
    const l = getLabelFor(el);
    return l || (safeAttr(el,'aria-label') || '').trim();
  }

  /* ===================== 6) COLLECTOR ===================== */
  function collectCandidateElements(doc){
    doc = doc || document;
    const selectors = [
      'input:not([type="hidden"])','button','a','select','textarea',
      '[role="button"]','span[role="button"]',
      '[data-ctl]','[data-qa-locator]','[data-aura-class]','[data-aura-rendered-by]','[data-key]','[data-id]',
      'lightning-input','lightning-button','lightning-combobox','lightning-textarea',
      'lightning-record-edit-form','lightning-tab','lightning-input-field','lightning-formatted-text',
      'force-record-view','force-input','force-button','force-lookup','force-list-view'
    ];
    let basics = [];
    try { basics = Array.from(doc.querySelectorAll(selectors.join(','))); } catch(e){ basics = []; }
    let filtered = basics.filter(el => !shouldSkip(el));
    const seen = new Set();
    filtered = filtered.filter(el=>{
      const anchor = getSmartAnchorTextSafe(el) || '';
      const sig = [
        el.tagName.toLowerCase(),
        el.id||'',
        safeAttr(el,'name')||'',
        safeAttr(el,'data-qa-locator')||'',
        safeAttr(el,'data-ctl')||'',
        safeAttr(el,'data-key')||'',
        safeAttr(el,'data-id')||'',
        anchor
      ].join('|');
      if(seen.has(sig)) return false;
      seen.add(sig);
      return true;
    });
    return filtered;
  }

  /* ===================== 7) GENERATORS ===================== */
  function genBasicXPath(el){
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    if (el.id) return `//*[@id=${xpathLiteral(el.id)}]`;
    const name = safeAttr(el,'name');
    if (name) return `//${tag}[@name=${xpathLiteral(name)}]`;
    const label = getLabelFor(el);
    if (label) return `//${tag}[contains(normalize-space(.), ${xpathLiteral(label.trim())})]`;
    const cls = (safeAttr(el,'class')||'').trim().split(/\s+/).filter(Boolean)[0];
    if (cls) return `//${tag}[contains(concat(' ', normalize-space(@class), ' '), ${xpathLiteral(' ' + cls + ' ')})]`;
    const parent = el.parentElement;
    if (!parent) return `//${tag}[1]`;
    const same = Array.from(parent.children).filter(x => x.tagName === el.tagName);
    const idx = same.indexOf(el) + 1;
    return `${genBasicXPath(parent)}/${tag}[${idx}]`;
  }
  function genWildcardXPath(el){
    if(!el) return '';
    if (el.id) return `//*[@id=${xpathLiteral(el.id)}]`;
    const name = safeAttr(el,'name');
    if (name) return `//*[@name=${xpathLiteral(name)}]`;
    const label = getLabelFor(el);
    if (label) return `//*[contains(normalize-space(.), ${xpathLiteral(label.trim())})]`;
    const cls = (safeAttr(el,'class')||'').trim().split(/\s+/).filter(Boolean)[0];
    if (cls) return `//*[contains(concat(' ', normalize-space(@class), ' '), ${xpathLiteral(' ' + cls + ' ')})]`;
    return genBasicXPath(el);
  }
  function genAxesXPath(el){
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    const id = safeAttr(el,'id');
    if (id) return `//label[@for=${xpathLiteral(id)}]/following::${tag}[1]`;
    const al = safeAttr(el,'aria-labelledby');
    if (al) return `//*[@id=${xpathLiteral(al.split(/\s+/)[0])}]/following::${tag}[1]`;
    const label = getLabelFor(el);
    if (label) return `//label[contains(normalize-space(.), ${xpathLiteral(label.trim())})]/following::${tag}[1]`;
    return genBasicXPath(el);
  }
  function genFunctionXPath(el){
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    const ph = safeAttr(el,'placeholder');
    if (ph && String(ph).trim()) return `//${tag}[contains(@placeholder, ${xpathLiteral(ph)})]`;
    const ti = safeAttr(el,'title');
    if (ti && String(ti).trim()) return `//${tag}[contains(@title, ${xpathLiteral(ti)})]`;
    const alt = safeAttr(el,'alt');
    if (alt && String(alt).trim()) return `//${tag}[contains(@alt, ${xpathLiteral(alt)})]`;
    return genBasicXPath(el);
  }
  function genSalesforceXPath(el){
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    if (safeAttr(el,'data-qa-locator')) return `//${tag}[@data-qa-locator=${xpathLiteral(safeAttr(el,'data-qa-locator'))}]`;
    if (safeAttr(el,'data-key')) return `//${tag}[@data-key=${xpathLiteral(safeAttr(el,'data-key'))}]`;
    if (safeAttr(el,'title')) return `//${tag}[@title=${xpathLiteral(safeAttr(el,'title'))}]`;
    if (safeAttr(el,'data-aura-rendered-by')) return `//${tag}[@data-aura-rendered-by=${xpathLiteral(safeAttr(el,'data-aura-rendered-by'))}]`;
    return genBasicXPath(el);
  }
  function genSalesforceLWCXPath(el){
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    if (safeAttr(el,'data-id')) return `//${tag}[@data-id=${xpathLiteral(safeAttr(el,'data-id'))}]`;
    if (safeAttr(el,'data-field')) return `//${tag}[@data-field=${xpathLiteral(safeAttr(el,'data-field'))}]`;
    if (/^lightning-/.test(tag)){
      return `(//${tag}[@data-id or @data-field or @data-key or @title or @data-qa-locator])[1]`;
    }
    return genSalesforceXPath(el);
  }
  function genSalesforceAuraXPath(el){
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    if (safeAttr(el,'data-aura-class')) return `//${tag}[@data-aura-class=${xpathLiteral(safeAttr(el,'data-aura-class'))}]`;
    if (safeAttr(el,'data-aura-rendered-by')) return `//${tag}[@data-aura-rendered-by=${xpathLiteral(safeAttr(el,'data-aura-rendered-by'))}]`;
    return genSalesforceXPath(el);
  }
  function genPegaXPath(el){
    if(!el) return '';
    const tag = el.tagName.toLowerCase();
    if (safeAttr(el,'data-test-id')) return `//${tag}[@data-test-id=${xpathLiteral(safeAttr(el,'data-test-id'))}]`;
    if (safeAttr(el,'data-node-id')) return `//${tag}[@data-node-id=${xpathLiteral(safeAttr(el,'data-node-id'))}]`;
    if (safeAttr(el,'data-ctl')) return `//${tag}[@data-ctl=${xpathLiteral(safeAttr(el,'data-ctl'))}]`;
    if (safeAttr(el,'role') === 'button') return `//${tag}[@role='button']`;
    return genBasicXPath(el);
  }

  /* ===================== 8) CHOOSER ===================== */
  function firstNonEmpty(){
    for (let i=0;i<arguments.length;i++){ const v = arguments[i]; if (typeof v === 'string' && v.trim()) return v; }
    return null;
  }
  function bestXPath(el){
    try {
      const lwc = genSalesforceLWCXPath(el);
      const aura = genSalesforceAuraXPath(el);
      const sfg = genSalesforceXPath(el);
      const pega = genPegaXPath(el);
      const axes = genAxesXPath(el);
      const fnc  = genFunctionXPath(el);
      const wild = genWildcardXPath(el);
      const basic= genBasicXPath(el);
      return firstNonEmpty(lwc, aura, sfg, pega, axes, fnc, wild, basic);
    } catch(e){ return genBasicXPath(el); }
  }

  /* ===================== 9) HIGHLIGHTING ===================== */
  function evaluateXPathInRoot(xpath, rootNode){
    try {
      const doc = (rootNode && rootNode.ownerDocument) ? rootNode.ownerDocument : (rootNode && rootNode.nodeType ? rootNode : document);
      const res = doc.evaluate(xpath, rootNode, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null);
      return res && res.singleNodeValue ? res.singleNodeValue : null;
    } catch (e) { return null; }
  }
  function findInShadowRoots(xpath, startRoot){
    startRoot = startRoot || document;
    const walker = (root)=>{
      try { const found = evaluateXPathInRoot(xpath, root); if(found) return found; } catch(e){}
      const nodes = (root.querySelectorAll) ? root.querySelectorAll('*') : [];
      for (let i=0;i<nodes.length;i++){
        const n = nodes[i];
        if (n.shadowRoot){
          const f = findInShadowRoots(xpath, n.shadowRoot);
          if (f) return f;
        }
      }
      return null;
    };
    return walker(startRoot);
  }
  function findInIframes(xpath, win){
    win = win || window;
    try {
      const found = evaluateXPathInRoot(xpath, win.document);
      if (found) return {el: found, win: win};
      const sf = findInShadowRoots(xpath, win.document);
      if (sf) return {el: sf, win: win};
      const frames = win.document.querySelectorAll ? win.document.querySelectorAll('iframe, frame') : [];
      for (let i=0;i<frames.length;i++){
        const fr = frames[i];
        try {
          const cw = fr.contentWindow;
          if (!cw) continue;
          const inner = findInIframes(xpath, cw);
          if (inner && inner.el) return inner;
        } catch(e){ continue; }
      }
    } catch(e){}
    return null;
  }
  function transientHighlightElement(el, options){
    if(!el || !el.style) return;
    options = options || {};
    const color = options.color || 'rgba(255,165,0,0.55)';
    const outlineColor = options.outline || 'rgba(255,165,0,0.95)';
    const orig = { boxShadow: el.style.boxShadow || '', outline: el.style.outline || '', zIndex: el.style.zIndex || '', transition: el.style.transition || '' };
    try { el.style.transition = 'box-shadow 0.15s ease'; } catch(e){}
    try { el.style.boxShadow = `0 0 0 4px ${color}, inset 0 0 0 1px #fff`; } catch(e){}
    try { el.style.outline = `2px solid ${outlineColor}`; } catch(e){}
    try { el.style.zIndex = '2147483647'; } catch(e){}
    try { el.scrollIntoView({behavior:'auto', block:'center', inline:'center'}); } catch(e){}
    const timeout = (options.duration || 3500);
    setTimeout(()=>{ try{ el.style.boxShadow = orig.boxShadow; el.style.outline = orig.outline; el.style.zIndex = orig.zIndex; el.style.transition = orig.transition; } catch(e){} }, timeout);
  }
  NS.tryHighlightByXPath = function(xpath){
    if(!xpath || typeof xpath !== 'string'){ dbg('tryHighlightByXPath needs xpath'); return false; }
    try { const direct = evaluateXPathInRoot(xpath, document); if (direct){ transientHighlightElement(direct); return true; } } catch(e){}
    try { const sf = findInShadowRoots(xpath, document); if (sf){ transientHighlightElement(sf); return true; } } catch(e){}
    try {
      const preview = document.getElementById('preview') || document.querySelector('iframe#preview');
      if (preview){
        try {
          const doc = preview.contentDocument;
          if (doc){
            const d = evaluateXPathInRoot(xpath, doc);
            if (d){ transientHighlightElement(d, {color:'rgba(0,150,255,0.45)', outline:'rgba(0,120,255,0.9)'}); return true; }
            const sfs = findInShadowRoots(xpath, doc);
            if (sfs){ transientHighlightElement(sfs, {color:'rgba(0,150,255,0.45)', outline:'rgba(0,120,255,0.9)'}); return true; }
          }
        } catch(err){ dbg('preview inaccessible', err); }
      }
    } catch(e){ dbg(e); }
    try { const res = findInIframes(xpath, window); if (res && res.el){ transientHighlightElement(res.el, {color:'rgba(0,150,255,0.45)', outline:'rgba(0,120,255,0.9)'}); return true; } } catch(e){}
    dbg('tryHighlightByXPath: not found', xpath);
    return false;
  };
  NS.tryHighlightAllByXPath = function(xpath){
    if(!xpath || typeof xpath !== 'string') return 0;
    let count = 0;
    try {
      const it = document.evaluate(xpath, document, null, XPathResult.ORDERED_NODE_ITERATOR_TYPE, null);
      let n;
      while ((n = it.iterateNext())){ transientHighlightElement(n, {color:'rgba(0,200,100,0.35)', outline:'rgba(0,150,100,0.9)', duration:4500}); count++; }
    } catch(e){}
    try { const res = findInIframes(xpath, window); if (res && res.el){ transientHighlightElement(res.el, {color:'rgba(0,150,255,0.45)', outline:'rgba(0,120,255,0.9)', duration:4500}); count++; } } catch(e){}
    return count;
  };

  /* ===================== 10) TEMPLATE UTIL ===================== */
  function toTemplate(xpath){
    if (!xpath || typeof xpath !== 'string') return xpath || '';
    let s = xpath;
    s = s.replace(/(["'])(?:(?=(\\?))\2.)*?\1/g, (m)=> { if (m.length <= 2) return m; return m[0] + '%s' + m[m.length-1]; });
    s = s.replace(/\[(\d+)\]/g, "[%s]");
    s = s.replace(/\s+/g, ' ').trim();
    return s;
  }

  /* ===================== 11) RENDERERS ===================== */
  function pickValue(row, panel){
    panel = panel || 'basic';
    if (row.xpaths && row.xpaths[panel]) return row.xpaths[panel];
    if (panel === 'css') return row.css || row.cssSelector || '';
    if (panel === 'playwright') {
      if (!row.playwright) return '';
      if (typeof row.playwright === 'string') return row.playwright;
      try { return JSON.stringify(row.playwright); } catch(e){ return ''; }
    }
    if (row[panel]) return row[panel];
    return (row.xpaths && (row.xpaths.sf || row.xpaths.pega || row.xpaths.basic)) || row.sf || row.pega || row.basic || row.css || '';
  }

  NS.fillLocatorList = function(panel = 'basic'){
    panel = panel || 'basic';
    const data = Array.isArray(window.CURRENT_LOCATORS) ? window.CURRENT_LOCATORS : [];
    let container = document.getElementById('locator-list');
    if (!container){
      container = document.createElement('div');
      container.id = 'locator-list';
      container.style.cssText = 'margin:12px 0; overflow:auto; max-height:55vh; border:1px solid #ddd; border-radius:8px; background:#fff;padding:8px;';
      document.body.appendChild(container);
    }
    const rows = data.map((r,i)=>({ id: r.id || `E${i+1}`, tag: r.tag || '', text: (r.text||'').toString(), framework: r.framework||'', raw: pickValue(r,panel)||'' })).filter(r => String(r.raw).trim().length > 0);
    const tableHTML = `
      <table style="width:100%; border-collapse:collapse; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;">
        <thead>
          <tr style="background:#f7f7f7; position:sticky; top:0;">
            <th style="width:36px; text-align:center; padding:8px; border-bottom:1px solid #e5e5e5;">✓</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e5e5;">ID</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e5e5;">Tag</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e5e5;">Label</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e5e5;">Framework</th>
            <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e5e5;">${panel.toUpperCase()}</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map((r,idx)=>`
            <tr data-row="${idx}" style="cursor:default;">
              <td style="text-align:center; padding:8px; border-bottom:1px solid #f0f0f0;"><input class="loc-check" type="checkbox"></td>
              <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${r.id}</td>
              <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${r.tag}</td>
              <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${r.text.replace(/</g,'&lt;')}</td>
              <td style="padding:8px; border-bottom:1px solid #f0f0f0;">${r.framework}</td>
              <td class="loc-val" style="padding:8px; border-bottom:1px solid #f0f0f0; font-family:ui-monospace, Menlo, Consolas, monospace;"><div style="white-space:pre-wrap; word-break:break-word;">${String(r.raw).replace(/</g,'&lt;')}</div></td>
            </tr>`).join('')}
        </tbody>
      </table>`;
    container.innerHTML = tableHTML;

    // Toolbar
    let bar = document.getElementById('locator-toolbar');
    if (!bar){
      bar = document.createElement('div');
      bar.id = 'locator-toolbar';
      bar.style.cssText = 'display:flex; gap:12px; align-items:center; margin:10px 0;';
      bar.innerHTML = `
        <label style="user-select:none;"><input type="checkbox" id="loc-sel-all"> Select all</label>
        <label style="user-select:none;"><input type="checkbox" id="loc-template"> Template (%s)</label>
        <button id="loc-copy" style="padding:6px 10px; border:1px solid #ccc; border-radius:6px; background:#f6f6f6; cursor:pointer;">Copy selected</button>
        <button id="loc-download" style="padding:6px 10px; border:1px solid #ccc; border-radius:6px; background:#f6f6f6; cursor:pointer;">Download selected</button>
        <span id="loc-count" style="margin-left:auto; color:#555;"></span>
      `;
      container.parentNode.insertBefore(bar, container);
    } else {
      const countEl = document.getElementById('loc-count');
      if (countEl) countEl.textContent = '';
    }

    const countEl = document.getElementById('loc-count');
    if (countEl) countEl.textContent = `${rows.length} locators • panel: ${panel}`;

    const selAll = document.getElementById('loc-sel-all');
    const tmpl = document.getElementById('loc-template');
    const btnCopy = document.getElementById('loc-copy');
    const btnDown = document.getElementById('loc-download');
    const checks = Array.from(container.querySelectorAll('.loc-check'));
    selAll.onchange = ()=>{ checks.forEach(c => c.checked = selAll.checked); };

    tmpl.onchange = ()=> {
      const useTpl = tmpl.checked;
      container.querySelectorAll('tbody tr').forEach(tr => {
        const i = Number(tr.getAttribute('data-row'));
        const val = useTpl ? toTemplate(rows[i].raw) : rows[i].raw;
        tr.querySelector('.loc-val > div').textContent = val;
      });
    };

    btnCopy.onclick = async ()=> {
      const useTpl = tmpl.checked; const selected = [];
      container.querySelectorAll('tbody tr').forEach(tr => {
        const cb = tr.querySelector('.loc-check'); if (cb && cb.checked){ const i = Number(tr.getAttribute('data-row')); selected.push(useTpl ? toTemplate(rows[i].raw) : rows[i].raw); }
      });
      const text = selected.join('\n');
      const ok = await copyToClipboard(text);
      if (ok) showToast(`Copied ${selected.length} locator(s)`); else alert('Copy failed — please copy manually');
    };

    btnDown.onclick = ()=> {
      const useTpl = tmpl.checked; const selected = [];
      container.querySelectorAll('tbody tr').forEach(tr => {
        const cb = tr.querySelector('.loc-check'); if (cb && cb.checked){ const i = Number(tr.getAttribute('data-row')); selected.push(useTpl ? toTemplate(rows[i].raw) : rows[i].raw); }
      });
      const blob = new Blob([selected.join('\n')], {type:'text/plain'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `locators_${panel}${useTpl ? '_template' : ''}.txt`; document.body.appendChild(a); a.click(); a.remove();
    };

    container.querySelectorAll('tbody tr').forEach((tr, idx)=> {
      tr.addEventListener('click', async (ev)=> {
        if (ev.target && ev.target.classList && ev.target.classList.contains('loc-check')) return;
        const valDiv = tr.querySelector('.loc-val > div'); if(!valDiv) return;
        const val = valDiv.textContent || ''; let xpath = val || '';
        if (!xpath && Array.isArray(window.CURRENT_LOCATORS) && window.CURRENT_LOCATORS[idx]) xpath = pickValue(window.CURRENT_LOCATORS[idx], panel);
        if (xpath) { const ok = NS.tryHighlightByXPath(xpath); await copyToClipboard(xpath); if (ok) showToast('Copied & highlighted'); else showToast('Copied (highlight failed)'); }
        else showToast('No locator to copy');
      });
    });

    return container;
  };

  NS.printFillLocatorList = function(panel, containerId){
    panel = panel || 'basic'; containerId = containerId || 'locator-dump';
    const data = Array.isArray(window.CURRENT_LOCATORS) ? window.CURRENT_LOCATORS : [];
    let box = document.getElementById(containerId);
    if (!box){ box = document.createElement('div'); box.id = containerId; box.style.cssText = 'margin:16px 0; padding:12px; border:1px solid #ddd; border-radius:10px; background:#fff;'; document.body.appendChild(box); }
    const rows = data.map((r,i)=>({ id: r.id || `E${i+1}`, tag: r.tag||'', text: (r.text||'').toString(), framework: r.framework||'', val: pickValue(r,panel)||'' })).filter(r => r.val && String(r.val).trim().length > 0);
    const table = `
      <div style="font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial">
        <div style="margin-bottom:8px;"><strong>Standalone Locator Dump</strong> — panel: <code>${panel}</code> — count: <strong>${rows.length}</strong></div>
        <table style="width:100%; border-collapse:collapse;">
          <thead><tr style="background:#f7f7f7"><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e5e5;">ID</th><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e5e5;">Tag</th><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e5e5;">Label</th><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e5e5;">Framework</th><th style="text-align:left;padding:8px;border-bottom:1px solid #e5e5e5;">${panel.toUpperCase()}</th></tr></thead>
          <tbody>${rows.map(r=>`<tr><td style="padding:8px;border-bottom:1px solid #f0f0f0;">${r.id}</td><td style="padding:8px;border-bottom:1px solid #f0f0f0;">${r.tag}</td><td style="padding:8px;border-bottom:1px solid #f0f0f0;">${r.text.replace(/</g,'&lt;')}</td><td style="padding:8px;border-bottom:1px solid #f0f0f0;">${r.framework}</td><td style="padding:8px;border-bottom:1px solid #f0f0f0;font-family:ui-monospace,Menlo,Consolas,monospace;"><div style="white-space:pre-wrap;word-break:break-word;">${String(r.val).replace(/</g,'&lt;')}</div></td></tr>`).join('')}</tbody>
        </table>
      </div>`;
    box.innerHTML = table;
    return rows.length;
  };

  /* ===================== 12) DYNAMIC PICKER ===================== */
  let pickerState = null;
  function ensureDynamicPanel(){
    let toolbar = document.getElementById('locator-toolbar');
    if(!toolbar){
      const container = document.getElementById('locator-list') || document.body;
      toolbar = document.createElement('div');
      toolbar.id = 'locator-toolbar';
      toolbar.style.cssText = 'display:flex; gap:10px; align-items:center; margin:10px 0;';
      container.parentNode.insertBefore(toolbar, container);
    }
    if (toolbar.dataset.dynamicAttached) return toolbar;
    toolbar.dataset.dynamicAttached = '1';
    // basic controls (templates + picker + apply + preview + copy)
    const select = document.createElement('select'); select.id = 'dynamic-template-select'; select.style.cssText = 'padding:6px;border-radius:6px;border:1px solid #ccc;';
    const templateOptions = [
      {k:'id', lbl:"//*[@id='%s']"},
      {k:'data', lbl:"//*[@data-xxx='%s']"},
      {k:'name', lbl:"//*[@name='%s']"},
      {k:'aria', lbl:"//*[@aria-label='%s']"},
      {k:'exact-text', lbl:"//tag[text()='%s']"},
      {k:'contains-text', lbl:"//tag[contains(normalize-space(.),'%s')]"},
      {k:'custom', lbl:"Custom"}
    ];
    templateOptions.forEach(t=>{ const opt=document.createElement('option'); opt.value=t.k; opt.textContent=t.lbl; select.appendChild(opt); });
    const pickerBtn = document.createElement('button'); pickerBtn.id='dynamic-picker-btn'; pickerBtn.textContent='Open Picker'; pickerBtn.style.cssText='padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;';
    const applyBtn = document.createElement('button'); applyBtn.id='dynamic-apply-btn'; applyBtn.textContent='Apply to selected'; applyBtn.style.cssText='padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer;';
    const preview = document.createElement('input'); preview.id='dynamic-preview'; preview.placeholder='Generated template preview'; preview.style.cssText='padding:6px;border-radius:6px;border:1px solid #ddd;min-width:320px;';
    const copyBtn = document.createElement('button'); copyBtn.id='dynamic-copy-btn'; copyBtn.textContent='Copy'; copyBtn.style.cssText='padding:6px 8px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer;';
    toolbar.appendChild(select); toolbar.appendChild(pickerBtn); toolbar.appendChild(applyBtn); toolbar.appendChild(preview); toolbar.appendChild(copyBtn);

    pickerBtn.addEventListener('click', ()=> openDynamicPicker(select.value, (templates, el) => {
      document.getElementById('dynamic-preview').value = (templates && templates[0]) || '';
      toolbar.dataset.lastTemplates = JSON.stringify(templates || []);
      try { toolbar.dataset.lastPickedElementXPath = bestXPath(el) || ''; } catch(e){}
    }));
    copyBtn.addEventListener('click', async ()=> { const val = document.getElementById('dynamic-preview').value || ''; if(!val) return; try{ await copyToClipboard(val); showToast('Template copied'); }catch(e){ alert('Copied: '+val); }});
    applyBtn.addEventListener('click', ()=> {
      const last = toolbar.dataset.lastTemplates ? JSON.parse(toolbar.dataset.lastTemplates) : [];
      if(!last || last.length===0){ alert('No template generated. Use picker first.'); return; }
      const table = document.getElementById('locator-list'); if(!table){ alert('Locator list not present'); return; }
      const checks = Array.from(table.querySelectorAll('tbody .loc-check'));
      const sel = checks.map((c,i)=> ({checked:c.checked, rowIndex:i})).filter(x=>x.checked).map(x=>x.rowIndex);
      if(sel.length===0){ alert('No rows selected.'); return; }
      sel.forEach(idx => { const tr = table.querySelector(`tbody tr[data-row="${idx}"]`); if(!tr) return; const valCell = tr.querySelector('.loc-val > div'); if(valCell) valCell.textContent = last[0]; });
      showToast(`Applied template to ${sel.length} row(s)`);
    });
    return toolbar;
  }

  function generateTemplatesForElement(el){
    const out = [];
    if(!el) return out;
    if (el.id) out.push(`//*[@id='${'%s'}']`.replace(/'%s'|"%s"/g, "'%s'"));
    const dataAttrs = Array.from(el.attributes||[]).filter(a=>/^data-/.test(a.name)).map(a=>a.name);
    if (dataAttrs.length) out.push(`//*[@${dataAttrs[0]}='%s']`);
    if (safeAttr(el,'name')) out.push(`//*[@name='%s']`);
    if (safeAttr(el,'aria-label')) out.push(`//*[@aria-label='%s']`);
    const txt = (el.textContent||'').trim();
    if (txt) out.push(`//${el.tagName.toLowerCase()}[normalize-space(text())='%s']`);
    if (txt) out.push(`//${el.tagName.toLowerCase()}[contains(normalize-space(.),'%s')]`);
    const cls = (safeAttr(el,'class')||'').split(/\s+/).filter(Boolean)[0];
    if (cls) out.push(`//${el.tagName.toLowerCase()}[contains(concat(' ', normalize-space(@class), ' '),' ${cls} ')]`.replace(/%s/g,'%s'));
    try { const bx = genBasicXPath(el) || ''; if(bx){ const replaced = bx.replace(/\[\d+\]/g, '[%s]'); if(replaced !== bx) out.push(replaced); else out.push(bx); } } catch(e){}
    return Array.from(new Set(out)).filter(Boolean);
  }

  function openDynamicPicker(startTemplateKey, onComplete){
    if (pickerState) return;
    const overlay = document.createElement('div'); overlay.id = 'dynamic-picker-overlay'; overlay.style.cssText = 'position:fixed; inset:0; background: rgba(0,0,0,0.25); z-index:2147483646; cursor:crosshair;';
    const hint = document.createElement('div'); hint.style.cssText = 'position:fixed; top:16px; right:16px; background:#fff; padding:10px 12px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2); z-index:2147483647;';
    hint.innerHTML = '<strong>Dynamic Picker</strong><div style="margin-top:6px;">Hover element & click to pick. Press ESC to cancel.</div>';
    document.body.appendChild(overlay); document.body.appendChild(hint);
    let lastHover = null;
    function onMouseOver(e){
      const t = e.target;
      if (lastHover && lastHover !== t) try { lastHover.style.outline = lastHover._origOutline || ''; } catch(e){}
      lastHover = t;
      if (t.closest && t.closest('#dynamic-picker-overlay, #locator-toolbar, #locator-list, #locator-dump')) return;
      try { lastHover._origOutline = t.style.outline || ''; } catch(e){}
      try { t.style.outline = '3px solid rgba(0,200,150,0.85)'; } catch(e){}
      e.stopPropagation();
    }
    function onClick(e){
      e.preventDefault(); e.stopPropagation();
      const picked = e.target; cleanup();
      const templates = generateTemplatesForElement(picked);
      if (typeof onComplete === 'function') onComplete(templates, picked);
    }
    function onKey(e){ if (e.key === 'Escape'){ cleanup(); showToast('Picker canceled'); } }
    function cleanup(){ try { document.removeEventListener('mouseover', onMouseOver, true); document.removeEventListener('click', onClick, true); document.removeEventListener('keydown', onKey, true); } catch(e){} if(lastHover) try{ lastHover.style.outline = lastHover._origOutline || ''; } catch(e){} overlay.remove(); hint.remove(); pickerState = null; }
    document.addEventListener('mouseover', onMouseOver, true); document.addEventListener('click', onClick, true); document.addEventListener('keydown', onKey, true);
    pickerState = { overlay, cleanup };
  }
  function closeDynamicPicker(){ if (pickerState && typeof pickerState.cleanup === 'function') pickerState.cleanup(); }
  NS.openDynamicPicker = openDynamicPicker; NS.closeDynamicPicker = closeDynamicPicker; NS.generateTemplatesForElement = generateTemplatesForElement;

  /* ===================== 13) ACTION CANDIDATE FINDER ===================== */
  function isVisible(el){ if(!el || el.nodeType!==1) return false; if (el.hasAttribute('hidden')) return false; if (safeAttr(el,'aria-hidden') === 'true') return false; const s = (safeAttr(el,'style')||'').toLowerCase(); if (/display\s*:\s*none|visibility\s*:\s*hidden|opacity\s*:\s*0/.test(s)) return false; return true; }
  function looksLikeAction(el){
    if(!isVisible(el)) return false;
    const txt = (el.innerText||'').trim().toLowerCase();
    const title = (safeAttr(el,'title')||'').toLowerCase();
    const al = (safeAttr(el,'aria-label')||'').toLowerCase();
    const signals = ['action','actions','close','x','×','more','menu','submit','apply','ok','cancel'];
    for (const s of signals){ if (txt === s || txt.indexOf(s) !== -1) return true; if (title.indexOf(s) !== -1) return true; if (al.indexOf(s) !== -1) return true; }
    const svgs = el.querySelectorAll ? Array.from(el.querySelectorAll('svg, i, span')) : [];
    for (const node of svgs){ const cls = (node.getAttribute && (node.getAttribute('class')||'') || '').toLowerCase(); if(/close|times|x-icon|icon-close|fa-close|fa-times|more|ellipsis/.test(cls)) return true; const aria = (node.getAttribute && (node.getAttribute('aria-label')||'') || '').toLowerCase(); if(aria && /close|more|menu/.test(aria)) return true; }
    if (safeAttr(el,'data-action') || safeAttr(el,'data-click')) return true;
    return false;
  }
  NS.findActionCandidates = function(scopeDoc){
    const doc = scopeDoc || (typeof window.CURRENT_DOC !== 'undefined' && window.CURRENT_DOC) ? window.CURRENT_DOC : document;
    const all = Array.from(doc.querySelectorAll('button, a, [role="button"], div, span'));
    const cands = all.filter(looksLikeAction);
    const mapped = cands.map((el,i)=> { const basic = genBasicXPath(el); const sf = genSalesforceXPath(el); const pega = genPegaXPath(el); return { index: i+1, node: el, text: (el.innerText||'').trim(), title: safeAttr(el,'title')||'', aria: safeAttr(el,'aria-label')||'', basicXPath: basic, sfXPath: sf, pegaXPath: pega, css: (typeof window.generateCssSelector === 'function') ? window.generateCssSelector(el) : '' }; });
    window.CURRENT_LOCATORS = mapped.map((m, idx)=> ({ id: `A${idx+1}`, tag: (m.node.tagName||'').toLowerCase(), text: m.text || m.title || m.aria || '', framework: (m.sfXPath ? 'Salesforce+' : (m.pegaXPath ? 'Pega+' : '')), xpaths: { basic: m.basicXPath, sf: m.sfXPath, pega: m.pegaXPath }, css: m.css, elementRef: m.node }));
    if (typeof NS.printFillLocatorList === 'function') NS.printFillLocatorList('basic','locator-dump'); else { let box = document.getElementById('locator-dump'); if(!box){ box = document.createElement('pre'); box.id='locator-dump'; box.style.cssText='background:#fff; padding:12px; border:1px solid #ccc; max-height:40vh; overflow:auto;'; document.body.appendChild(box); } box.textContent = mapped.map((m,i)=>`${i+1}. ${m.text || m.title || m.aria}\n basic: ${m.basicXPath}\n sf: ${m.sfXPath}\n pega: ${m.pegaXPath}\n`).join('\n'); }
    return mapped;
  };
  NS.highlightCandidate = function(n, color){
    color = color || 'rgba(255,165,0,0.55)';
    const list = window.CURRENT_LOCATORS || []; const idx = Number(n) - 1;
    if(!list[idx]) { console.warn('no candidate at', n); return; }
    const el = list[idx].elementRef || list[idx].element || null;
    if(!el){ console.warn('element ref missing'); return; }
    const orig = el.style.boxShadow; el.style.boxShadow = `0 0 0 3px ${color}, inset 0 0 0 1px #fff`; setTimeout(()=>{ el.style.boxShadow = orig; }, 2500);
    dbg('highlighted candidate', n, el);
  };

  /* ===================== 14) ARTIFACTS GENERATOR ===================== */
  NS._normLocs = function(locs){ return (locs || []).map((l,i)=>{ if(typeof l === 'string') return { name: `elem${i+1}`, xpath: l }; const name = l.name || l.fieldName || (`elem${i+1}`); const xpath = l.xpath || l.locator || `//*[@id='${name}']`; return { name, xpath }; }); };
  NS.buildArtifactsFiles = function(options){
    options = options || {}; const fw = (options.fw||'').toLowerCase(); const lang = (options.lang||'').toLowerCase(); const locs = NS._normLocs(options.locs || []).slice(0,50); const files = {};
    files["README.md"] = "# Auto-generated artifacts\nThis zip contains starter project files.";
    files["src/test/resources/config.properties"] = `base.url=https://your-app.example.com\nbrowser=chrome\nheadless=false\nusername=demoUser\npassword=demoPass\n`;
    if(fw === 'selenium' && lang === 'java'){
      files["pom.xml"] = `<?xml version="1.0" encoding="UTF-8"?><project xmlns="http://maven.apache.org/POM/4.0.0">...</project>`;
      const fields = locs.map(l => `    @FindBy(xpath = "${l.xpath.replace(/"/g,'\\"')}")\n    private WebElement ${l.name};`).join('\n\n');
      const methods = locs.map((l,i)=>{ const cap = l.name.charAt(0).toUpperCase() + l.name.slice(1); return `    public void click${cap}(){ ${l.name}.click(); }\n    public void hover${cap}(){ new org.openqa.selenium.interactions.Actions(driver).moveToElement(${l.name}).perform(); }\n    public void sendKeys${cap}(String val){ ${l.name}.clear(); ${l.name}.sendKeys(val != null ? val : "sampleValue${i+1}"); }`; }).join('\n\n');
      files["src/main/java/com/pageobjects/SamplePage.java"] = `package com.pageobjects;\n\nimport org.openqa.selenium.WebDriver;\nimport org.openqa.selenium.WebElement;\nimport org.openqa.selenium.support.FindBy;\nimport org.openqa.selenium.support.PageFactory;\n\npublic class SamplePage {\n    WebDriver driver;\n\n${fields}\n\n    public SamplePage(WebDriver driver){\n        this.driver = driver;\n        PageFactory.initElements(driver, this);\n    }\n\n${methods}\n}`;
      return files;
    }
    if(fw === 'selenium' && lang === 'javascript'){
      files["package.json"] = JSON.stringify({ name:"adhyan-selenium-js", version:"1.0.0", scripts:{ test: "mocha test/*.js --timeout 20000" }, dependencies: { "selenium-webdriver":"4.11.0" } }, null, 2);
      files["test/test_sample.js"] = `const {Builder, By} = require('selenium-webdriver'); (async()=>{let d=new Builder().forBrowser('chrome').build(); try{await d.get('https://your-app.example.com'); // interact with locators here } finally{ await d.quit(); }})();`;
      return files;
    }
    if(fw === 'playwright' && (lang === 'javascript' || lang === 'typescript')){
      files["package.json"] = JSON.stringify({ name:"adhyan-pw-js", devDependencies: {"@playwright/test":"latest"}, scripts:{ test:"npx playwright test" } }, null, 2);
      files["tests/login.spec.js"] = `const { test, expect } = require('@playwright/test'); test('smoke', async ({ page }) => { await page.goto('https://your-app.example.com'); // use locators here });`;
      return files;
    }
    if(fw === 'playwright' && lang === 'python'){
      files["requirements.txt"] = "playwright==latest\npytest==latest\n";
      files["test/test_playwright.py"] = `from playwright.sync_api import sync_playwright\n\ndef test_login():\n    with sync_playwright() as pw:\n        b = pw.chromium.launch(headless=False)\n        p = b.new_page()\n        p.goto("https://your-app.example.com")\n        assert p.title() is not None\n        b.close()\n`;
      return files;
    }
    return files;
  };
  NS.downloadZipFromFiles = async function(filesMap, zipName){
    if (!window.JSZip){ alert('JSZip not loaded. Add <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>'); return; }
    const zip = new JSZip(); Object.keys(filesMap).forEach(path=> zip.file(path, filesMap[path])); const blob = await zip.generateAsync({type:"blob"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = zipName || 'automation_project.zip'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };

  /* ===================== 15) MAIN EXTRACTOR ===================== */
  NS.extractAllLocators = function(forceUseIframe){
    let DOC = document;
    const preview = document.getElementById('preview') || document.querySelector('iframe#preview');
    if (preview && !forceUseIframe){
      try { if (preview.contentDocument) { DOC = preview.contentDocument; dbg('using preview.contentDocument'); } } catch(e){ dbg('preview inaccessible', e); showToast('Preview DOM inaccessible (cross-origin). Using parsed DOM instead.'); }
    }
    if ((!DOC || DOC === document) && window._PARSER_DOC) DOC = window._PARSER_DOC;
    if (!DOC) DOC = document;
    let elements = collectCandidateElements(DOC);
    elements = elements.filter(el => !shouldSkip(el));
    const results = [];
    for (const el of elements){
      const attrs = { id: el.id || null, name: safeAttr(el,'name') || null, 'data-qa-locator': safeAttr(el,'data-qa-locator') || null, 'data-ctl': safeAttr(el,'data-ctl') || null, 'data-aura-class': safeAttr(el,'data-aura-class') || null, 'data-aura-rendered-by': safeAttr(el,'data-aura-rendered-by') || null, 'data-key': safeAttr(el,'data-key') || null, 'data-id': safeAttr(el,'data-id') || null, role: safeAttr(el,'role') || null, placeholder: safeAttr(el,'placeholder') || null, type: safeAttr(el,'type') || null };
      const xpaths = { basic: genBasicXPath(el), wildcards: genWildcardXPath(el), axes: genAxesXPath(el), functions: genFunctionXPath(el), sf: genSalesforceXPath(el), sflwc: genSalesforceLWCXPath(el), sfaura: genSalesforceAuraXPath(el), pega: genPegaXPath(el) };
      const css = (typeof window.generateCssSelector === 'function') ? window.generateCssSelector(el) : '';
      const playwright = (typeof window.generatePlaywrightSelectors === 'function') ? window.generatePlaywrightSelectors(el) : '';
      const anchors = getSmartAnchorTextSafe(el);
      const best = bestXPath(el);
      results.push({ element: el, tag: el.tagName.toLowerCase(), attrs, anchors, xpaths, css, playwright, best });
    }
    const seen = new Set(); const deduped = [];
    for (const r of results){
      if(!r.element || shouldSkip(r.element)) continue;
      const sig = [ r.tag, r.attrs.id || '', r.attrs.name || '', r.attrs['data-qa-locator'] || '', r.attrs['data-ctl'] || '', r.attrs['data-key'] || '', r.attrs['data-id'] || '', r.anchors || '', r.best || '' ].join('|');
      if (seen.has(sig)) continue;
      seen.add(sig); deduped.push(r);
    }
    window.CURRENT_LOCATORS = deduped.map((d,i)=> ({ id: d.attrs.id || `E${i+1}`, tag: d.tag, text: d.anchors || d.attrs.name || (d.element && (d.element.innerText || d.element.textContent) ? (d.element.innerText || d.element.textContent).trim() : '') || '', framework: (d.xpaths && d.xpaths.sf) ? 'Salesforce+' : (d.xpaths && d.xpaths.pega) ? 'Pega+' : '', xpaths: { basic: d.xpaths.basic, wildcards: d.xpaths.wildcards, axes: d.xpaths.axes, functions: d.xpaths.functions, sf: d.xpaths.sf, sflwc: d.xpaths.sflwc, sfaura: d.xpaths.sfaura, pega: d.xpaths.pega }, css: d.css, playwright: d.playwright, elementRef: d.element }));
    try { NS.fillLocatorList('basic'); } catch(e){ dbg('fillLocatorList failed', e); }
    showToast(`Extracted ${window.CURRENT_LOCATORS.length} elements`);
    dbg('extractAllLocators ->', window.CURRENT_LOCATORS.length);
    return window.CURRENT_LOCATORS;
  };

  /* ===================== 16) AUTO INIT & INFO ===================== */
  try { ensureDynamicPanel(); } catch(e){ dbg('ensureDynamicPanel failed', e); }
  console.info('AdhyanFullPatch loaded. API on window.AdhyPatch: extractAllLocators(), fillLocatorList(panel), openDynamicPicker(), tryHighlightByXPath(), buildArtifactsFiles(options).');

});




// ===== START: ZIP + multi-file artifact generator helpers =====

// Helper: normalize locators (same as earlier)
function _normLocs(locs){
  return (locs || []).map((l,i) => {
    if(typeof l === 'string') return { name: `elem${i+1}`, xpath: l };
    const name = l.name || l.fieldName || (`elem${i+1}`);
    const xpath = l.xpath || l.locator || `//*[@id='${name}']`;
    return { name, xpath };
  });
}

// Helper: make a safe Java identifier from arbitrary name
function safeJavaName(raw, fallbackIndex){
  if(!raw) raw = `elem${fallbackIndex||0}`;
  // replace non-identifiers with underscore
  let s = String(raw).trim().replace(/[^a-zA-Z0-9_$]/g, '_');
  // cannot start with digit
  if(/^[0-9]/.test(s)) s = '_' + s;
  // ensure not empty
  if(!s) s = `elem${fallbackIndex||0}`;
  return s;
}

// escape double quotes and backslashes for Java string literal
function escapeForJavaString(s){
  return String(s || '').replace(/\\/g, '\\\\').replace(/"/g, '\\"');
}

// Example: build files map for Java + Selenium (TestNG + Cucumber)
function buildArtifactsFiles(options){
  options = options || {};
  const fw = (options.fw||'').toLowerCase();
  const lang = (options.lang||'').toLowerCase();
  const runner = (options.runner||'').toLowerCase();
  const locsRaw = _normLocs(options.locs || []);
  const locs = locsRaw.slice(0, 20); // limit to 20 by default

  // We'll return a map: key = relative path (inside zip), value = file content
  const files = {};

  // Common config
  files["src/test/resources/config.properties"] =
`base.url=https://your-pega-login-url.example.com
browser=chrome
headless=false
username=demoUser
password=demoPass
`;

  // For Java + Selenium
  if(fw === 'selenium' && lang === 'java'){
    // pom.xml (minimal, usable)
    files["pom.xml"] =
`<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <groupId>com.example</groupId>
  <artifactId>pega-selenium-java</artifactId>
  <version>1.0-SNAPSHOT</version>
  <properties>
    <maven.compiler.source>11</maven.compiler.source>
    <maven.compiler.target>11</maven.compiler.target>
  </properties>
  <dependencies>
    <dependency>
      <groupId>org.seleniumhq.selenium</groupId>
      <artifactId>selenium-java</artifactId>
      <version>4.11.0</version>
    </dependency>
    <dependency>
      <groupId>org.testng</groupId>
      <artifactId>testng</artifactId>
      <version>7.8.0</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>io.github.bonigarcia</groupId>
      <artifactId>webdrivermanager</artifactId>
      <version>5.5.1</version>
    </dependency>
    <dependency>
      <groupId>io.cucumber</groupId>
      <artifactId>cucumber-java</artifactId>
      <version>8.13.0</version>
    </dependency>
    <dependency>
      <groupId>io.cucumber</groupId>
      <artifactId>cucumber-testng</artifactId>
      <version>8.13.0</version>
    </dependency>
  </dependencies>
</project>
`;

    // BaseTest.java
    files["src/main/java/com/tests/base/BaseTest.java"] = `package com.tests.base;

import java.io.FileInputStream;
import java.io.InputStream;
import java.time.Duration;
import java.util.Properties;
import io.github.bonigarcia.wdm.WebDriverManager;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.chrome.ChromeDriver;
import org.testng.annotations.AfterClass;
import org.testng.annotations.BeforeClass;

public class BaseTest {
    protected WebDriver driver;
    protected Properties config = new Properties();

    @BeforeClass
    public void setUp() {
        try (InputStream in = new FileInputStream("src/test/resources/config.properties")) {
            config.load(in);
        } catch (Exception e) {
            e.printStackTrace();
        }

        String browser = config.getProperty("browser", "chrome");
        boolean headless = Boolean.parseBoolean(config.getProperty("headless", "false"));

        if ("chrome".equalsIgnoreCase(browser)) {
            WebDriverManager.chromedriver().setup();
            ChromeOptions opts = new ChromeOptions();
            if (headless) opts.addArguments("--headless=new");
            opts.addArguments("--start-maximized");
            driver = new ChromeDriver(opts);
        } else {
            WebDriverManager.chromedriver().setup();
            driver = new ChromeDriver();
        }

        driver.manage().timeouts().implicitlyWait(Duration.ofSeconds(10));
        driver.get(config.getProperty("base.url", "https://google.com"));
    }

    @AfterClass
    public void tearDown() {
        if (driver != null) driver.quit();
    }

    public WebDriver getDriver(){ return driver; }
}
`;

    // Build PageObject fields & methods (with safe names)
    const usedNames = new Set();
    const fieldEntries = locs.map((l, idx) => {
      const base = safeJavaName(l.name || `elem${idx+1}`, idx+1);
      let name = base;
      let counter = 1;
      while(usedNames.has(name)){
        name = `${base}_${counter++}`;
      }
      usedNames.add(name);
      const escapedXpath = escapeForJavaString(l.xpath || '');
      return {
        name,
        xpath: escapedXpath
      };
    });

    // fields
    const fields = fieldEntries.map(f => `    @FindBy(xpath = "${f.xpath}")\n    private WebElement ${f.name};`).join('\n\n');

    // methods
    const methods = fieldEntries.map((f, i) => {
      const cap = f.name.charAt(0).toUpperCase() + f.name.slice(1);
      return `    public void click${cap}(){ ${f.name}.click(); }\n    public void hover${cap}(){ new Actions(driver).moveToElement(${f.name}).perform(); }\n    public void sendKeys${cap}(String val){ ${f.name}.clear(); ${f.name}.sendKeys(val != null ? val : "sampleValue${i+1}"); }`;
    }).join('\n\n');

    files["src/main/java/com/pageobjects/SamplePage.java"] = `package com.pageobjects;

import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.interactions.Actions;
import org.openqa.selenium.support.FindBy;
import org.openqa.selenium.support.PageFactory;

/*
 Auto-generated SamplePage
*/
public class SamplePage {
    WebDriver driver;

${fields}

    public SamplePage(WebDriver driver){
        this.driver = driver;
        PageFactory.initElements(driver, this);
    }

${methods}
}
`;

    // Sample TestNG test
    const sampleTestBody = fieldEntries.map((f, i) => {
      const cap = f.name.charAt(0).toUpperCase() + f.name.slice(1);
      const mod = i % 3;
      if (mod === 0) return `        p.sendKeys${cap}(null);`;
      if (mod === 1) return `        p.click${cap}();`;
      return `        p.hover${cap}();`;
    }).join('\n');

    files["src/test/java/com/tests/SampleTest.java"] = `package com.tests;

import com.pageobjects.SamplePage;
import com.tests.base.BaseTest;
import org.testng.annotations.Test;

public class SampleTest extends BaseTest {

    @Test
    public void quickFlow() throws InterruptedException {
        SamplePage p = new SamplePage(driver);
${sampleTestBody}
        Thread.sleep(2000);
    }
}
`;

    // Optional Cucumber feature + steps (simple template)
    files["src/test/resources/features/sample.feature"] = `Feature: Auto-generated feature

  Scenario: basic flow
    Given user navigates to base url
    When user performs generated steps
    Then verify result
`;

    // Step definitions
    let stepBody = `package com.stepdefs;

import com.pageobjects.SamplePage;
import com.tests.base.BaseTest;
import io.cucumber.java.en.*;
import org.testng.Assert;

public class SampleSteps extends BaseTest {
    SamplePage page;

    @Given("user navigates to base url")
    public void user_navigates() { page = new SamplePage(driver); }
`;
    fieldEntries.forEach((f, i) => {
      const cap = f.name.charAt(0).toUpperCase()+f.name.slice(1);
      const mod = i % 3;
      if(i===0) stepBody += `    @When("user enters ${f.name}")\n    public void enter_${f.name}(){ page.sendKeys${cap}(null); }\n`;
      else if(mod===1) stepBody += `    @And("user clicks ${f.name}")\n    public void click_${f.name}(){ page.click${cap}(); }\n`;
      else stepBody += `    @And("user hovers ${f.name}")\n    public void hover_${f.name}(){ page.hover${cap}(); }\n`;
    });
    stepBody += `    @Then("user should see result")\n    public void verify(){ Assert.assertTrue(driver.getTitle()!=null); }\n}`;
    files["src/test/java/com/stepdefs/SampleSteps.java"] = stepBody;

    return files;
  }

  // For other combos (Selenium JS/TS/PY, Playwright) generate minimal per-language files
  if(fw === 'selenium' && lang === 'javascript'){
    files["package.json"] = JSON.stringify({
      name:"pega-selenium-js",
      version:"1.0.0",
      scripts:{ test: "mocha test/*.js --timeout 20000" },
      dependencies: { "selenium-webdriver":"4.11.0" }
    }, null, 2);
    files["test/test_sample.js"] = `const {Builder, By} = require('selenium-webdriver');
(async()=>{
  let d = new Builder().forBrowser('chrome').build();
  try{
    await d.get('https://your-pega-login-url.example.com');
    // sample actions - update XPaths as needed
    await d.findElement(By.xpath("//input")).sendKeys('sampleUser');
    await new Promise(r=>setTimeout(r,1500));
  } finally{
    await d.quit();
  }
})();`;
    return files;
  }

  if(fw === 'playwright'){
    if(lang === 'javascript' || lang === 'typescript'){
      files["package.json"] = JSON.stringify({ name:"pega-pw-js", devDependencies: {"@playwright/test":"latest"}, scripts:{ test:"npx playwright test" } }, null, 2);
      files["tests/login.spec.js"] = `const { test, expect } = require('@playwright/test');
test('login', async ({ page }) => {
  await page.goto('https://your-pega-login-url.example.com');
  // replace selectors with ones from your locators if available
  await page.fill("//input[@placeholder='User name']", 'sampleUser');
  await page.fill("//input[@placeholder='Password']", 'samplePass');
  await page.click("//button[normalize-space()='Log in']");
  await expect(page).toHaveTitle(/.*/);
});`;
      return files;
    }
    if(lang === 'python'){
      files["requirements.txt"] = "playwright==latest\npytest==latest\n";
      files["test/test_playwright.py"] = `from playwright.sync_api import sync_playwright

def test_login():
    with sync_playwright() as pw:
        b = pw.chromium.launch(headless=False)
        p = b.new_page()
        p.goto("https://your-pega-login-url.example.com")
        p.fill("//input[@placeholder='User name']", "sampleUser")
        p.fill("//input[@placeholder='Password']", "samplePass")
        p.click("//button[normalize-space()=\\"Log in\\"]")
        assert p.title() is not None
        b.close()
`;
      return files;
    }
  }

  // fallback: minimal README
  files["README.md"] = "No builder for selected combo yet. Please extend buildArtifactsFiles().";
  return files;
}

// Utility: create zip in browser and trigger download (uses JSZip)
async function downloadZipFromFiles(filesMap, zipName){
  if (!window.JSZip) {
    alert('JSZip not loaded. Add <script src=\"https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js\"></script>');
    return;
  }
  const zip = new JSZip();
  Object.keys(filesMap).forEach(path => {
    zip.file(path, filesMap[path]);
  });
  const blob = await zip.generateAsync({type:"blob"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = zipName || 'automation_project.zip';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// small helper to display files in your output area - optional
function showFilesInOutput(filesMap, outputEl){
  if(!outputEl) return;
  outputEl.value = ''; // clear
  const keys = Object.keys(filesMap).sort();
  keys.forEach(path => {
    outputEl.value += `// ==== FILE: ${path} ====\n${filesMap[path]}\n\n`;
  });
}

// Example hook: wire to your existing Generate button
document.getElementById('btnGenPOM')?.addEventListener('click', async ()=>{
  try {
    // get UI selections (adapt to your code)
    const fw = document.querySelector('.sw[data-fw].active')?.dataset?.fw || 'selenium';
    const runner = document.querySelector('.sw[data-runner].active')?.dataset?.runner || 'testng';
    const lang = document.querySelector('.sw[data-lang].active')?.dataset?.lang || 'java';
    // CURRENT_LOCATORS should be your extractor array - example: [{name:'username', xpath:'...'}, ...]
    const filesMap = buildArtifactsFiles({fw, runner, lang, locs: window.CURRENT_LOCATORS || []});

    // show in output textarea (if exists)
    const output = document.getElementById('output') || document.querySelector('textarea.output');
    if(output) showFilesInOutput(filesMap, output);

    // create zip and trigger download (if JSZip present)
    await downloadZipFromFiles(filesMap, `pega-${fw}-${lang}-${runner || 'run'}.zip`);
    alert('ZIP generated & download started');
  } catch(err){
    console.error('Artifact generation failed', err);
    alert('Artifact generation failed: ' + (err && err.message ? err.message : String(err)));
  }
})();

// ===== END: ZIP + multi-file artifact generator helpers =====


</script>
</body>
</html>